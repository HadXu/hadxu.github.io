<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>一种迷你解释器 | lay&#39;s 博客</title>
    <meta property="og:title" content="一种迷你解释器 - lay&#39;s 博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-06-21T09:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-06-21T09:00:00&#43;08:00'>
        
    <meta name="Keywords" content="Python,Rust,Golang,6.824,">
    <meta name="description" content="一种迷你解释器">
        
    <meta name="author" content="lay">
    <meta property="og:url" content="https://hadxu.github.io/post/2021-06-21.A-tiny-Interpreter-written-by-Rust/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-4031353640611810" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://hadxu.github.io">
                        lay&#39;s 博客
                    </a>
                
                <p class="description">专注于C,Python,Rust,Golang,Haskell,分布式系统,分布式计算,kindle,kaggle</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://hadxu.github.io">首页</a>
                    
                    <a  href="https://hadxu.github.io/books/" title="书籍">书籍</a>
                    
                    <a  href="https://hadxu.github.io/films/" title="电影">电影</a>
                    
                    <a  href="https://hadxu.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://hadxu.github.io/about/" title="关于">关于</a>
                    
                    <a  href="https://hadxu.github.io/pdfs/" title="pdfs">pdfs</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li><a href="#1-定义token">1. 定义Token</a></li>
    <li><a href="#2-实现lexer">2. 实现lexer</a></li>
    <li><a href="#3-实现parser重点">3. 实现parser（重点）</a>
      <ul>
        <li><a href="#parser-let">parser let</a></li>
        <li><a href="#parser-return">parser return</a></li>
        <li><a href="#处理表达式-expression">处理表达式 expression</a></li>
      </ul>
    </li>
    <li><a href="#4-实现evaluator">4. 实现evaluator</a>
      <ul>
        <li><a href="#1-integer">1. Integer</a></li>
        <li><a href="#2-前缀">2. 前缀</a></li>
        <li><a href="#3-中缀">3. 中缀</a></li>
        <li><a href="#4-处理变量">4. 处理变量</a></li>
        <li><a href="#5-函数调用">5. 函数调用</a></li>
      </ul>
    </li>
    <li><a href="#5-扩展">5. 扩展</a></li>
    <li><a href="#6-支持wasm-todo">6. 支持wasm (todo)</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">一种迷你解释器</h1>
        </header>
        <date class="post-meta meta-date">
            2021年6月21日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/INTERPRETER'>INTERPRETER</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h1 id="编写一个解释器githubhttpsgithubcomhadxurust-lang">编写一个解释器(<a href="https://github.com/HadXu/rust-lang">Github</a>)</h1>
<p>程序语言是给人读写的语言，如何将程序语言变成可执行的代码需要经过翻译。目前计算机语言分为两种派别1、<a href="https://zh.wikipedia.org/wiki/%E7%9B%B4%E8%AD%AF%E5%99%A8">解释器</a>；2、<a href="">编译器</a>。其中解释器是边解释边执行，不需要将全部的代码一次性执行，经典的解释型语言有<code>Python、Ruby，Perl， Matlab</code>等等。而编译器则是将代码一次性编译成功然后执行，经典的编译型代码有<code>C, C++, Java, Go, Rust</code>等等，两者最大的区别在于速度以及执行方式，而从实现上来说解释器相对编译器要简单很多。这篇文章主要讲解了如何使用Rust语言来实现一个简单的解释器。为什么使用Rust，第一Rust是笔者最喜欢的语言之一，另外两个语言是<code>Python 和 C</code>。Rust被定义为系统级的编程语言，快，而笔者感觉Rust中最厉害的在于其匹配模式也就是<code>match</code>语法,简单来说</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">main</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">Foo</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span>x: (<span style="color:#458;font-weight:bold">u32</span>,<span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">u32</span>),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>y: <span style="color:#458;font-weight:bold">u32</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#998;font-style:italic">// Try changing the values in the struct to see what happens
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>foo<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Foo<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>x: (<span style="color:#099">1</span>,<span style="color:#bbb"> </span><span style="color:#099">2</span>),<span style="color:#bbb"> </span>y: <span style="color:#099">3</span><span style="color:#bbb"> </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>foo<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span>Foo<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>x: (<span style="color:#099">1</span>,<span style="color:#bbb"> </span>b),<span style="color:#bbb"> </span>y<span style="color:#bbb"> </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>println!(<span style="color:#d14">&#34;First of x is 1, b = {},  y = {} &#34;</span>,<span style="color:#bbb"> </span>b,<span style="color:#bbb"> </span>y),<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// you can destructure structs and rename the variables,
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// the order is not important
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span>Foo<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>y: <span style="color:#099">2</span>,<span style="color:#bbb"> </span>x: <span style="color:#458;font-weight:bold">i</span><span style="color:#bbb"> </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>println!(<span style="color:#d14">&#34;y is 2, i = {:?}&#34;</span>,<span style="color:#bbb"> </span>i),<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// and you can also ignore some variables:
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span>Foo<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>y,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">..</span><span style="color:#bbb"> </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>println!(<span style="color:#d14">&#34;y = {}, we don&#39;t care about x&#34;</span>,<span style="color:#bbb"> </span>y),<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// this will give an error: pattern does not mention field `x`
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">//Foo { y } =&gt; println!(&#34;y = {}&#34;, y),
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>该例子来自于<a href="https://doc.rust-lang.org/rust-by-example/flow_control/match/destructuring/destructure_structures.html">rust-by-example</a>,可以发现能够支持强大的匹配，从而得到具体的内容。在编写解释器期间，需要大量的匹配，通过Rust这种语言特性能够减少大量的代码，从而实现快速实现功能。</p>
<h1 id="概览">概览</h1>
<ol>
<li>定义Token</li>
<li>实现lexer</li>
<li>实现parser（重点）</li>
<li>实现evaluator</li>
<li>扩展迷你解释器</li>
</ol>
<h2 id="1-定义token">1. 定义Token</h2>
<p>第一步就是将人看懂的语言转换成对应有意义的<code>Token</code>,这个<code>Token</code>就是有意义的词，如编程语言中的<code>If, else, new, </code>等等。而这些<code>Token</code>在Rust中很容易被实现，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#999;font-weight:bold;font-style:italic">#[derive(Debug, Clone, PartialEq)]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Token</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>ILLEGAL,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>EOF,<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>IDENT(<span style="color:#0086b3">String</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>INT(<span style="color:#458;font-weight:bold">i64</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>BOOL(<span style="color:#458;font-weight:bold">bool</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>STRING(<span style="color:#0086b3">String</span>),<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span>ASSIGN,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>PLUS,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>MINUS,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>BANG,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>ASTERISK,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>SLASH,<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">..</span>.<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>具体的代码实现在<a href="https://github.com/HadXu/rust-lang/blob/main/src/token.rs">token.rs</a>,得益于Rust强大的匹配模式，我们定义了<code>IDENT(String)</code>,这是用来捕捉变量的一种方式，如<code>let x = 3;</code>,那么就会被翻译成</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Token::LET,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::ASSIGN,
Token::INT<span style="color:#000;font-weight:bold">(</span>3<span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
</code></pre></td></tr></table>
</div>
</div><p>是不是很简单！</p>
<h2 id="2-实现lexer">2. 实现lexer</h2>
<p>第一步只是定义了<code>Token</code>,那么如何将程序员写的语言转换成有意义的一个个Token，那么就需要<code>lexer analysis</code>操作。<strong>lexer analysis</strong>称之为词法分析，将字符序列转换为标记Token序列的过程。比如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>(<span style="color:#099">5</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span><span style="color:#099">10</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">true</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">false</span>;<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>对应的<code>Token</code>为</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Token::IF,
Token::LPAREN,
Token::INT<span style="color:#000;font-weight:bold">(</span>5<span style="color:#000;font-weight:bold">)</span>,
Token::LT,
Token::INT<span style="color:#000;font-weight:bold">(</span>10<span style="color:#000;font-weight:bold">)</span>,
Token::RPAREN,
Token::LBRACE,
Token::RETURN,
Token::BOOL<span style="color:#000;font-weight:bold">(</span><span style="color:#0086b3">true</span><span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
Token::RBRACE,
Token::ELSE,
Token::LBRACE,
Token::RETURN,
Token::BOOL<span style="color:#000;font-weight:bold">(</span><span style="color:#0086b3">false</span><span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
Token::RBRACE,
</code></pre></td></tr></table>
</div>
</div><p>因此需要一个算法来将所有的Token获取到。在这里使用读取每一个char，然后进行分析。
定义一个结构体来读取每一个char</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">struct</span> <span style="color:#458;font-weight:bold">Lexer</span><span style="color:#000;font-weight:bold">&lt;&#39;</span><span style="color:#008080">a</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>input: <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&#39;</span><span style="color:#008080">a</span> <span style="color:#458;font-weight:bold">str</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>pos: <span style="color:#458;font-weight:bold">usize</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>next_pos: <span style="color:#458;font-weight:bold">usize</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>ch: <span style="color:#458;font-weight:bold">u8</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>其中input是输入的字符串序列，pos指的是当前读取的索引，next_pos指的是下一个索引，ch指的是当前char。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">impl</span><span style="color:#000;font-weight:bold">&lt;&#39;</span><span style="color:#008080">a</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>Lexer<span style="color:#000;font-weight:bold">&lt;&#39;</span><span style="color:#008080">a</span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">new</span>(input: <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">&#39;</span><span style="color:#008080">a</span> <span style="color:#458;font-weight:bold">str</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Self</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>lexer<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Lexer<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>input,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>pos: <span style="color:#099">0</span>,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>next_pos: <span style="color:#099">0</span>,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>ch: <span style="color:#099">0</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">        </span>lexer.read_char();<span style="color:#bbb">
</span><span style="color:#bbb">        </span>lexer<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">read_char</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_pos<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.input.len()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.ch<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#099">0</span>;<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.ch<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.input.as_bytes()[<span style="color:#999">self</span>.next_pos];<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.pos<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_pos;<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_pos<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+=</span><span style="color:#bbb"> </span><span style="color:#099">1</span>;<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>每运行一次<code>read_char</code>就会读取一个char，并将pos移到下一个位置。对于下一个token的赋值，需要通过不同的匹配来实现</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#999;font-weight:bold;font-style:italic">#[allow(dead_code)]</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">next_token</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Token</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>tok<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.ch<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;=&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.nextch_is(<span style="color:#d14">b&#39;=&#39;</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#999">self</span>.read_char();<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::EQ<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::ASSIGN<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">..</span>.<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;!&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.nextch_is(<span style="color:#d14">b&#39;=&#39;</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#999">self</span>.read_char();<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::NOT_EQ<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::BANG<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">..</span>.<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;[&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::LBRACKET,<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;]&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::RBRACKET,<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;:&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::COLON,<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;a&#39;</span><span style="color:#000;font-weight:bold">..=</span><span style="color:#d14">b&#39;z&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span><span style="color:#d14">b&#39;A&#39;</span><span style="color:#000;font-weight:bold">..=</span><span style="color:#d14">b&#39;Z&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span><span style="color:#d14">b&#39;_&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.read_identifier(),<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;0&#39;</span><span style="color:#000;font-weight:bold">..=</span><span style="color:#d14">b&#39;9&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.read_number(),<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">b&#39;&#34;&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.read_string(),<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#099">0</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::EOF,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::ILLEGAL,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#999">self</span>.read_char();<span style="color:#bbb">
</span><span style="color:#bbb">    </span>tok<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>在这里就可以看到Rust语言强大的匹配功能了。如果下一个token是常见的特殊字符，直接进行匹配，如果是<code>ident、number、string</code>,那么就跳到对应的方法，如果是其他就是非法字符。</p>
<p>而对应的<strong>read_identifier</strong>如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">read_identifier</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Token</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>pos<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.pos;<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">loop</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.ch<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#d14">b&#39;a&#39;</span><span style="color:#000;font-weight:bold">..=</span><span style="color:#d14">b&#39;z&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span><span style="color:#d14">b&#39;A&#39;</span><span style="color:#000;font-weight:bold">..=</span><span style="color:#d14">b&#39;Z&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span><span style="color:#d14">b&#39;_&#39;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#999">self</span>.read_char();<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">                </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#000;font-weight:bold">break</span>;<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>literal<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;</span><span style="color:#999">self</span>.input[pos<span style="color:#000;font-weight:bold">..</span><span style="color:#999">self</span>.pos];<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>literal<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;fn&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::FUNCTION,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;let&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::LET,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;true&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::BOOL(<span style="color:#000;font-weight:bold">true</span>),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;false&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::BOOL(<span style="color:#000;font-weight:bold">false</span>),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;if&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::IF,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;else&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::ELSE,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">&#34;return&#34;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::RETURN,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Token::IDENT(<span style="color:#0086b3">String</span>::from(literal)),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>这里读取的是变量，如果是关键字变量，那么就返回对应的关键字Token，如果是普通的变量，那么久直接返回<code>Token::IDENT(String::from(literal)),</code>。而number或者string同理，对应的代码在<a href="https://github.com/HadXu/rust-lang/blob/main/src/lexer/mod.rs">lexer</a>中。</p>
<p>当完成Lexer之后，如果对以下的内容进行词法分析</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#0086b3">let</span> <span style="color:#008080">five</span> <span style="color:#000;font-weight:bold">=</span> 5; 
<span style="color:#0086b3">let</span> <span style="color:#008080">ten</span> <span style="color:#000;font-weight:bold">=</span> 10;
<span style="color:#0086b3">let</span> <span style="color:#008080">add</span> <span style="color:#000;font-weight:bold">=</span> fn<span style="color:#000;font-weight:bold">(</span>x, y<span style="color:#000;font-weight:bold">)</span>
    <span style="color:#000;font-weight:bold">{</span>x + y;<span style="color:#000;font-weight:bold">}</span>; 
<span style="color:#0086b3">let</span> <span style="color:#008080">result</span> <span style="color:#000;font-weight:bold">=</span> add<span style="color:#000;font-weight:bold">(</span>five, ten<span style="color:#000;font-weight:bold">)</span>;
!-/*5;
</code></pre></td></tr></table>
</div>
</div><p>所得到的内容为</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">Token::LET,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;five&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::ASSIGN,
Token::INT<span style="color:#000;font-weight:bold">(</span>5<span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
Token::LET,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ten&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::ASSIGN,
Token::INT<span style="color:#000;font-weight:bold">(</span>10<span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
Token::LET,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;add&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::ASSIGN,
Token::FUNCTION,
Token::LPAREN,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::COMMA,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;y&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::RPAREN,
Token::LBRACE,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;x&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::PLUS,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;y&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::SEMICOLON,
Token::RBRACE,
Token::SEMICOLON,
Token::LET,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;result&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::ASSIGN,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;add&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::LPAREN,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;five&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::COMMA,
Token::IDENT<span style="color:#000;font-weight:bold">(</span>String::from<span style="color:#000;font-weight:bold">(</span><span style="color:#d14">&#34;ten&#34;</span><span style="color:#000;font-weight:bold">))</span>,
Token::RPAREN,
Token::SEMICOLON,
Token::BANG,
Token::MINUS,
Token::SLASH,
Token::ASTERISK,
Token::INT<span style="color:#000;font-weight:bold">(</span>5<span style="color:#000;font-weight:bold">)</span>,
Token::SEMICOLON,
</code></pre></td></tr></table>
</div>
</div><p>这就是词法分析，仅仅是将每一个char进行整合，并没有各种策略在其中。</p>
<h2 id="3-实现parser重点">3. 实现parser（重点）</h2>
<p>当完成了词法分析之后，就需要进行语法分析。语法分析是比较难的地方，整个过程设计到递归，因此需要对递归有一定的理解。<strong>parser</strong>主要的功能是将第二步得到的一个个词进行整理为<a href="https://en.wikipedia.org/wiki/Abstract_syntax_tree">语法树</a>。如图所示

        <img class="mx-auto" alt="" src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c7/Abstract_syntax_tree_for_Euclidean_algorithm.svg/800px-Abstract_syntax_tree_for_Euclidean_algorithm.svg.png" />   
    ，根据表达式优先级的高低，对词进行排序，优先级越高的就先执行，优先级低的就后执行。
比如下面的简单的4则运算

        <img class="mx-auto" alt="" src="https://hadxu-blog-1251872278.cos.ap-shanghai.myqcloud.com/imgs/op.png" />   
    ,然后通过第4步的计算得到最终的结果。</p>
<h3 id="parser-let">parser let</h3>
<p>语法如下</p>
<pre tabindex="0"><code>let &lt;identifier&gt; = &lt;expression&gt;;
</code></pre><p><code>let</code>是最简单的语法，<code>let</code>后跟着一个<code>identifier</code>，然后是<code>=</code>, 最后是表达式，如果<code>let</code>之后不是<code>identifier</code>,那么就语法错误。
相对应的代码如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_let_stmt</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Stmt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;</span><span style="color:#999">self</span>.next_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::IDENT(_)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#d14">&#34;expected next token to be IDENT, got {:?} instead&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#999">self</span>.next_token<span style="color:#bbb">
</span><span style="color:#bbb">            </span>),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 下一个token应该是 identifier
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>name<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_ident()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(name)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>name,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 再下一个token应该是 =
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::ASSIGN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>;<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 最后是一个表达式
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>expr<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>expression;<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 函数返回的是一个抽象语法树
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(Stmt::Let(name,<span style="color:#bbb"> </span>expr))<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#d14">/// identifier处理
</span><span style="color:#d14"></span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_ident</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Ident<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::IDENT(<span style="color:#000;font-weight:bold">ref</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>ident)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(Ident(ident.clone())),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>当函数<code>parse_let_stmt</code>完成，返回的是一个抽象语法树，而这个语法树是一个<code>let</code>表达式

        <img class="mx-auto" alt="" src="https://hadxu-blog-1251872278.cos.ap-shanghai.myqcloud.com/imgs/let.png" />   
    ,而这个是在<a href="https://github.com/HadXu/rust-lang/blob/main/src/ast.rs">ast.rs</a>中定义的</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Stmt</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Let(Ident,<span style="color:#bbb"> </span>Expr),<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Expr</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Ident(Ident),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Literal(Literal),<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#d14">/// 字面意思
</span><span style="color:#d14"></span><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Literal</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Int(<span style="color:#458;font-weight:bold">i64</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Bool(<span style="color:#458;font-weight:bold">bool</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#0086b3">String</span>(<span style="color:#0086b3">String</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Array(<span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Hash(<span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>(Expr,<span style="color:#bbb"> </span>Expr)<span style="color:#000;font-weight:bold">&gt;</span>),<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>当进行<code>let x = 5;</code>返回的是一个这样的语法树</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">Stmt::Let(<span style="color:#bbb"> </span>Ident(<span style="color:#0086b3">String</span>::from(<span style="color:#d14">&#34;x&#34;</span>)),<span style="color:#bbb"> </span>Expr::Literal(Literal::Int(<span style="color:#099">5</span>))<span style="color:#bbb"> </span>),<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>前面是一个变量，后面是一个表达式。</p>
<h3 id="parser-return">parser return</h3>
<p>语法如下</p>
<pre tabindex="0"><code>return expression;
</code></pre><p><code>return</code>也很简单，遇到<code>return</code>关键字就处理该语句。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_return_stmt</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Stmt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>expr<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span>expression<span style="color:#000;font-weight:bold">&gt;</span>;<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 如果遇到了; 那么就结束
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::SEMICOLON)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 返回该表达式
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(Stmt::Return(expr))<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="处理表达式-expression">处理表达式 expression</h3>
<p>表达式是计算机语言中最有意思的地方。表达式有很多种，以下都属于表达式</p>
<ul>
<li>一元操作符
<pre tabindex="0"><code>-5
!true
</code></pre></li>
<li>二元操作符
<pre tabindex="0"><code>5+5
5 - 5
5 * 5
5 / 5
</code></pre></li>
<li>比较符
<pre tabindex="0"><code>foo == foo
foo &lt; bar
</code></pre></li>
<li>括号
<pre tabindex="0"><code>5 * (5 + 5)
</code></pre></li>
<li>函数调用
<pre tabindex="0"><code>add(3, 5)
max(5, add(5, 6))
add(x, y)
</code></pre></li>
<li>if
<pre tabindex="0"><code>if (10&gt;5) {true} else {false}
</code></pre></li>
</ul>
<p>处理表达式最简单的是自顶向下的方法，<a href="https://hadxu-blog-1251872278.cos.ap-shanghai.myqcloud.com/imgs/Top%20Down%20Operator%20Precedence.pdf">Top Down Operator Precedence</a>是作者<a href="https://en.wikipedia.org/wiki/Vaughan_Pratt">Vaughan Pratt</a>于1973年提出的一种方法，遇到表达式就通过优先级来处理表达式。</p>
<p>首先一个整体框架为</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_stmt</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Stmt<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::LET<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_let_stmt(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::RETURN<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_return_stmt(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr_stmt(),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>如果是<code>let、return</code>那么就处理各自的语句，如果两个都不是，那就是表达式，直接来处理表达式。</p>
<p>需要处理的表示有以下几类</p>
<ol>
<li>identifiers</li>
<li>integer</li>
<li>prefix op</li>
<li>infix op</li>
</ol>
<h4 id="1-identifiers">1. identifiers</h4>
<p>如果遇到的是<code>identifiers</code>,那么有以下几种情况遇到这个<code>identifiers</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">add<span style="color:#000;font-weight:bold">(</span>foo, bar<span style="color:#000;font-weight:bold">)</span>;
foo + bar;
<span style="color:#000;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span>foo<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>

<span style="color:#000;font-weight:bold">}</span>
</code></pre></td></tr></table>
</div>
</div><p>如果是这几种情况就直接处理。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_ident</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Ident<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::IDENT(<span style="color:#000;font-weight:bold">ref</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>ident)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(Ident(ident.clone())),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="2-integer">2. integer</h4>
<p>如果遇到的是数值类型的expression，也很简单直接处理</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_int_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::INT(v)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(Expr::Literal(Literal::Int(v.clone()))),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="3-prefix-op">3. prefix op</h4>
<p>一元运算符有以下几种情况</p>
<pre tabindex="0"><code>-5
!foobar
5 + -9
</code></pre><p>同时具有优先级在其中，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_prefix_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>prefix<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span>Token::BANG<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Prefix::NOT,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>Token::MINUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Prefix::MINUS,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>Token::PLUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Prefix::PLUS,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;not support prefix op&#34;</span>),<span style="color:#bbb">
</span><span style="color:#bbb">    </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr(Precedence::PREFIX)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(expr)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(Expr::Prefix(prefix,<span style="color:#bbb"> </span><span style="color:#0086b3">Box</span>::new(expr))),<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>而优先级的定义如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Precedence</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>LOWEST,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>EQUALS,<span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// ==
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>LESSGREATER,<span style="color:#bbb"> </span><span style="color:#998;font-style:italic">// &gt; or &lt;
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>SUM,<span style="color:#bbb">         </span><span style="color:#998;font-style:italic">// +
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>PRODUCT,<span style="color:#bbb">     </span><span style="color:#998;font-style:italic">// *
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>PREFIX,<span style="color:#bbb">      </span><span style="color:#998;font-style:italic">// -X or !X
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>CALL,<span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// myFunction(x)
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">    </span>Index,<span style="color:#bbb">       </span><span style="color:#998;font-style:italic">// array[index]
</span><span style="color:#998;font-style:italic"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>越高的越优先处理，在代码的<a href="https://github.com/HadXu/rust-lang/blob/main/src/parser/mod.rs#L158">parser/mod.rs</a>158行中，有一个这样的语句</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">while</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::SEMICOLON)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;&amp;</span><span style="color:#bbb"> </span>precedence<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_precedence()<span style="color:#bbb"> 
</span></code></pre></td></tr></table>
</div>
</div><p>这句话的意思是如果当前的优先级没有下一个token的优先级高，那么就处理当前的表达式，并产生一个抽象语法树。除了函数调用以及索引，一元表达式是最高的，因此优先处理。</p>
<h4 id="4-infix-op">4. infix op</h4>
<p>中缀表达式是最常见的表达式，如</p>
<pre tabindex="0"><code>5 + 5
5 - 8
6 * 8
6 / 8
8 == 8
7 != 8
</code></pre><p>都属于中缀表达式，中缀表达式一般语法是</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&lt;expression&gt; &lt;infix op&gt; &lt;expression&gt;
</code></pre></td></tr></table>
</div>
</div><p>也就是左边是表达式，右边也是表达式，因此需要两边都处理</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_infix_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>left: <span style="color:#458;font-weight:bold">Expr</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>infix<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::PLUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::PLUS,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::MINUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::MINUS,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::SLASH<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::DIVIDE,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::ASTERISK<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::MULTIPLY,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::EQ<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::EQUAL,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::NOT_EQ<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::NOTEQUAL,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::LT<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::LESSTHAN,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::GT<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Infix::GREATERTHAN,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;do not support {:?}&#34;</span>,<span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>precedence<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token_precedence();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr(precedence)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(expr)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(Expr::Infix(infix,<span style="color:#bbb"> </span><span style="color:#0086b3">Box</span>::new(left),<span style="color:#bbb"> </span><span style="color:#0086b3">Box</span>::new(expr))),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>在这里传入的是一个左表达式值，因为左值处理完了，处理的是右表达式，首先判断运算符是什么？ 然后得到当前的符号的优先级，如果比下一个优先级低就处理下一个，否则直接返回，具体代码在</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>precedence: <span style="color:#458;font-weight:bold">Precedence</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// prefix
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::IDENT(_)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_ident_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::STRING(_)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_string_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::INT(_)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_int_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::BANG<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::MINUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::PLUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_prefix_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::LPAREN<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_grouped_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::BOOL(_)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_bool_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::IF<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_if_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::FUNCTION<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_func_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::LBRACKET<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_array_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Token::LBRACE<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_hash_expr(),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;do not support {:?} token&#34;</span>,<span style="color:#bbb"> </span><span style="color:#999">self</span>.current_token),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#998;font-style:italic">// infix
</span><span style="color:#998;font-style:italic"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">while</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::SEMICOLON)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;&amp;</span><span style="color:#bbb"> </span>precedence<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_precedence()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::PLUS<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::MINUS<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::SLASH<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::ASTERISK<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::EQ<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::NOT_EQ<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::LT<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span>Token::GT<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_infix_expr(left.unwrap());<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::LPAREN<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_call_expr(left.unwrap());<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::LBRACKET<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_index_expr(left.unwrap());<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">                </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>left,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>left<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="5-小括号处理">5. 小括号处理</h4>
<p>小括号一般是用来处理表达式中优先级的问题。</p>
<pre tabindex="0"><code>(5+5)*2
</code></pre><p>直接进行处理，当处理到小括号最后一个token的时候，必须是右括号进行结束</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">9
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_grouped_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>expr<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr(Precedence::LOWEST);<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::RPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#d14">&#34;error&#34;</span>);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>expr<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="6-if-表达式">6. if 表达式</h4>
<pre tabindex="0"><code>if (condition) &lt;consequence&gt; else &lt;alternative&gt;
</code></pre><p>其中<strong>condition</strong>是一个表达式，<strong>consequence</strong>是多个语句， <strong>alternative</strong>也是多个语句，</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_if_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::LPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#d14">&#34;execpt next token {:?} got {:?}&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb">                </span>Token::LPAREN,<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#999">self</span>.next_token<span style="color:#bbb">
</span><span style="color:#bbb">            </span>);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 处理条件语句
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>cond<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr(Precedence::LOWEST)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(expr)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>expr,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::RPAREN)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">||</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::LBRACE)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>;<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 处理第一个分支
</span><span style="color:#d14"></span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>consequence<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_block_stmt();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>alternative<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>;<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::ELSE)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::LBRACE)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>;<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">/// 如果有else分支就处理
</span><span style="color:#d14"></span><span style="color:#bbb">            </span>alternative<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(<span style="color:#999">self</span>.parse_block_stmt());<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 最后返回If表达式
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(Expr::If<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>cond: <span style="color:#0086b3">Box</span>::new(cond),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>consequence,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>alternative,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>})<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#d14">/// https://github.com/HadXu/rust-lang/blob/main/src/ast.rs
</span><span style="color:#d14"></span>If<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>cond: <span style="color:#0086b3">Box</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>consequence: <span style="color:#458;font-weight:bold">BlockStmt</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>alternative: <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>BlockStmt<span style="color:#000;font-weight:bold">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span>},<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="7-function">7. function</h4>
<p>function语法为</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#000;font-weight:bold">&lt;</span>parameters<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span>block<span style="color:#bbb"> </span>statement<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>其中<code>parameters</code>是以<code>,</code>分隔的多个参数，但是有可能有个参数都没有，因此在代码中需要实现这个逻辑</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_func_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::LPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#d14">&#34;except {:?} but found {:?}&#34;</span>,<span style="color:#bbb"> </span>Token::LPAREN,<span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 处理函数参数
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>params<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_func_params()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(params)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>params,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::LBRACE)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#d14">&#34;except {:?} but found {:?}&#34;</span>,<span style="color:#bbb"> </span>Token::LBRACE,<span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(Expr::Func<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>params,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#d14">/// 处理函数体
</span><span style="color:#d14"></span><span style="color:#bbb">            </span>body: <span style="color:#458;font-weight:bold">self</span>.parse_block_stmt(),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>})<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_func_params</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>Ident<span style="color:#000;font-weight:bold">&gt;&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>params<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>vec![];<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 如果下一个是右括号直接返回，无参数
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::RPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">Some</span>(params);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 得到每一个参数的ident
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_ident()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(ident)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>params.push(ident),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 如果还有参数，就继续push进列表
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">while</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token_is(<span style="color:#000;font-weight:bold">&amp;</span>Token::COMMA)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#999">self</span>.next_token();<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_ident()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#0086b3">Some</span>(ident)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>params.push(ident),<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!</span><span style="color:#999">self</span>.expect_next_token(Token::RPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#d14">&#34;except {:?} but found {:?}&#34;</span>,<span style="color:#bbb"> </span>Token::RPAREN,<span style="color:#bbb"> </span><span style="color:#999">self</span>.next_token);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(params)<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h4 id="8-函数调用">8. 函数调用</h4>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">&lt;expression&gt;<span style="color:#000;font-weight:bold">(</span>&lt;comma separated expression&gt;<span style="color:#000;font-weight:bold">)</span>
</code></pre></td></tr></table>
</div>
</div><p>这是最简单的函数调用，抽象语法如下</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">Call<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>func: <span style="color:#0086b3">Box</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb">    </span>args: <span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>,<span style="color:#bbb">
</span><span style="color:#bbb"></span>},<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>因此，只需要将函数名以及函数参数保存下来即可</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">parse_call_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>func: <span style="color:#458;font-weight:bold">Expr</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>args<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.parse_expr_list(Token::RPAREN)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(args)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>args,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#0086b3">Some</span>(Expr::Call<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>func: <span style="color:#0086b3">Box</span>::new(func),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>args,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>})<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>到这里基本的抽象语法树完成。</p>
<h2 id="4-实现evaluator">4. 实现evaluator</h2>
<p>这一步是解释器的最后一步求值。第三步虽然是重要的一步，但是仅仅完成了表达式的构建，并没有意义。比如<code>1+1</code> 抽象语法树也是<code>infix&lt;+, int(1), int(1)&gt;</code>,最终的程序是需要将这个计算出来的，也就是<code>2</code>，因此<strong>evaluator</strong>就是计算，就是求值，是有意义的一步。
一种方式是直接翻译抽象语法树，而另一种是转换为bytecode，然后求值。前者为解释器，后者为编译器。在本文中是解释器，通过遍历抽象语法树，求值得到最终的结果。</p>
<p>如果实现自己的解释器，首先需要一个值系统，用来表达Value，同时对value进行打印，如</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">pub</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">enum</span> <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span>Int(<span style="color:#458;font-weight:bold">i64</span>),<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb"></span><span style="color:#000;font-weight:bold">impl</span><span style="color:#bbb"> </span>fmt::Display<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>Object<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">fmt</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>f: <span style="color:#000;font-weight:bold">&amp;</span><span style="color:#458;font-weight:bold">mut</span><span style="color:#bbb"> </span>fmt::Formatter<span style="color:#000;font-weight:bold">&lt;&#39;</span><span style="color:#0086b3">_</span><span style="color:#000;font-weight:bold">&gt;</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">fmt</span>::<span style="color:#0086b3">Result</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#999">self</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::Int(<span style="color:#000;font-weight:bold">ref</span><span style="color:#bbb"> </span>value)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>write!(f,<span style="color:#bbb"> </span><span style="color:#d14">&#34;{}&#34;</span>,<span style="color:#bbb"> </span>value),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">..</span>.<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="1-integer">1. Integer</h3>
<p>如果是int类型，直接赋值给语言对象</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_literal</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>literal: <span style="color:#458;font-weight:bold">Literal</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>literal<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Literal::Int(value)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(value),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="2-前缀">2. 前缀</h3>
<p>前缀有3种，分别是</p>
<ol>
<li>
<ul>
<li></li>
</ul>
</li>
<li>
<ul>
<li></li>
</ul>
</li>
<li>!
直接进行求值即可</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_not_op_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>right: <span style="color:#458;font-weight:bold">Object</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>right<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::Bool(<span style="color:#000;font-weight:bold">true</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(<span style="color:#000;font-weight:bold">false</span>),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::Bool(<span style="color:#000;font-weight:bold">false</span>)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(<span style="color:#000;font-weight:bold">true</span>),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::NULL<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(<span style="color:#000;font-weight:bold">true</span>),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(<span style="color:#000;font-weight:bold">false</span>),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_minus_prefix_op_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>right: <span style="color:#458;font-weight:bold">Object</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>right<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::Int(value)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(<span style="color:#000;font-weight:bold">-</span>value),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;unknown operator: -{}&#34;</span>,<span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">    </span><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_plus_prefix_op_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>right: <span style="color:#458;font-weight:bold">Object</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>right<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Object::Int(value)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(value),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>_<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;unknown operator: +{}&#34;</span>,<span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="3-中缀">3. 中缀</h3>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_infix_int_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>infix: <span style="color:#458;font-weight:bold">Infix</span>,<span style="color:#bbb"> </span>left: <span style="color:#458;font-weight:bold">i64</span>,<span style="color:#bbb"> </span>right: <span style="color:#458;font-weight:bold">i64</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>infix<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::PLUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">+</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::MINUS<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">-</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::MULTIPLY<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">*</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::DIVIDE<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Int(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">/</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::LESSTHAN<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::GREATERTHAN<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::EQUAL<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">==</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Infix::NOTEQUAL<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::Bool(left<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!=</span><span style="color:#bbb"> </span>right),<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>整个求值系统本质上就是通过遍历抽象语法树，使用当前的语言将抽象语法树中的值求出来，然后赋值到新语言的系统当中。</p>
<h3 id="4-处理变量">4. 处理变量</h3>
<p>在处理变量的时候需要注意，变量是存在于语言系统中的，也就是可以被访问，如果定义了一个变量，就需要将该值存在于环境变量中，便于接下来的使用，比如函数调用等等。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_stmt</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>stmt: <span style="color:#458;font-weight:bold">Stmt</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#0086b3">Option</span><span style="color:#000;font-weight:bold">&lt;</span>Object<span style="color:#000;font-weight:bold">&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>stmt<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>Stmt::Let(ident,<span style="color:#bbb"> </span>expr)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>value<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.eval_expr(expr)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#0086b3">Some</span>(value)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>value,<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#0086b3">None</span>,<span style="color:#bbb">
</span><span style="color:#bbb">                </span>};<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span><span style="color:#999">Self</span>::is_error(<span style="color:#000;font-weight:bold">&amp;</span>value)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#0086b3">Some</span>(value)<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>Ident(name)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>ident;<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#999">self</span>.env.borrow_mut().set(name,<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&amp;</span>value);<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#0086b3">None</span><span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><p>其中的env就是一个kv数据结构。</p>
<h3 id="5-函数调用">5. 函数调用</h3>
<p>函数调用就是将之前的值绑定进行了利用</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust"><span style="color:#000;font-weight:bold">fn</span> <span style="color:#900;font-weight:bold">eval_call_expr</span>(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span><span style="color:#999">self</span>,<span style="color:#bbb"> </span>func: <span style="color:#0086b3">Box</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>,<span style="color:#bbb"> </span>args: <span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>Expr<span style="color:#000;font-weight:bold">&gt;</span>)<span style="color:#bbb"> </span>-&gt; <span style="color:#458;font-weight:bold">Object</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>args<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>args<span style="color:#bbb">
</span><span style="color:#bbb">            </span>.iter()<span style="color:#bbb">
</span><span style="color:#bbb">            </span>.map(<span style="color:#000;font-weight:bold">|</span>e<span style="color:#000;font-weight:bold">|</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.eval_expr(e.clone()).unwrap_or(Object::NULL))<span style="color:#bbb">
</span><span style="color:#bbb">            </span>.collect::<span style="color:#000;font-weight:bold">&lt;</span><span style="color:#0086b3">Vec</span><span style="color:#000;font-weight:bold">&lt;</span>_<span style="color:#000;font-weight:bold">&gt;&gt;</span>();<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>(params,<span style="color:#bbb"> </span>body,<span style="color:#bbb"> </span>env)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.eval_expr(<span style="color:#000;font-weight:bold">*</span>func)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(Object::Func(params,<span style="color:#bbb"> </span>body,<span style="color:#bbb"> </span>env))<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>(params,<span style="color:#bbb"> </span>body,<span style="color:#bbb"> </span>env),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(Object::Builtin(expect_param_num,<span style="color:#bbb"> </span>f))<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>expect_param_num<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#bbb"> </span><span style="color:#099">0</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">||</span><span style="color:#bbb"> </span>expect_param_num<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">==</span><span style="color:#bbb"> </span>args.len()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">as</span><span style="color:#bbb"> </span><span style="color:#458;font-weight:bold">i32</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>f(args);<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">else</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">                    </span>panic!(<span style="color:#d14">&#34;wrong number of arguments&#34;</span>);<span style="color:#bbb">
</span><span style="color:#bbb">                </span>}<span style="color:#bbb">
</span><span style="color:#bbb">            </span>}<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(o)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>panic!(<span style="color:#d14">&#34;{} is not valid function&#34;</span>,<span style="color:#bbb"> </span>o),<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">return</span><span style="color:#bbb"> </span>Object::NULL,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>};<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">if</span><span style="color:#bbb"> </span>params.len()<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">!=</span><span style="color:#bbb"> </span>args.len()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span>panic!(<span style="color:#bbb">
</span><span style="color:#bbb">                </span><span style="color:#d14">&#34;wrong number of arguments: {} expected but {} given&#34;</span>,<span style="color:#bbb">
</span><span style="color:#bbb">                </span>params.len(),<span style="color:#bbb">
</span><span style="color:#bbb">                </span>args.len()<span style="color:#bbb">
</span><span style="color:#bbb">            </span>)<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>current_env<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Rc::clone(<span style="color:#000;font-weight:bold">&amp;</span><span style="color:#999">self</span>.env);<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">mut</span><span style="color:#bbb"> </span>scoped_env<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Env::new_with_outer(Rc::clone(<span style="color:#000;font-weight:bold">&amp;</span>env));<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>list<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>params.iter().zip(args.iter());<span style="color:#bbb">
</span><span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#d14">/// 对新的函数参数进行值绑定
</span><span style="color:#d14"></span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">for</span><span style="color:#bbb"> </span>(_,<span style="color:#bbb"> </span>(ident,<span style="color:#bbb"> </span>o))<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">in</span><span style="color:#bbb"> </span>list.enumerate()<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>Ident(name)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>ident.clone();<span style="color:#bbb">
</span><span style="color:#bbb">            </span>scoped_env.set(name,<span style="color:#bbb"> </span>o);<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.env<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>Rc::new(RefCell::new(scoped_env));<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">let</span><span style="color:#bbb"> </span>object<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span><span style="color:#999">self</span>.eval_block_stmt(body);<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#999">self</span>.env<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=</span><span style="color:#bbb"> </span>current_env;<span style="color:#bbb">
</span><span style="color:#bbb">        </span><span style="color:#000;font-weight:bold">match</span><span style="color:#bbb"> </span>object<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">Some</span>(o)<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>o,<span style="color:#bbb">
</span><span style="color:#bbb">            </span><span style="color:#0086b3">None</span><span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">=&gt;</span><span style="color:#bbb"> </span>Object::NULL,<span style="color:#bbb">
</span><span style="color:#bbb">        </span>}<span style="color:#bbb">
</span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="5-扩展">5. 扩展</h2>
<p>对解释器进行了一些其他功能的扩展，包括</p>
<ol>
<li>string支持</li>
<li>内置方法</li>
<li>数组</li>
<li>hash</li>
</ol>
<h2 id="6-支持wasm-todo">6. 支持wasm (todo)</h2>
<p>使用wasm的支持将代码编译为wasm的代码</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-rust" data-lang="rust">rustup<span style="color:#bbb"> </span>target<span style="color:#bbb"> </span>add<span style="color:#bbb"> </span>wasm32<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#bbb">
</span><span style="color:#bbb"></span>cargo<span style="color:#bbb"> </span>build<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">--</span>bin<span style="color:#bbb"> </span>wasm<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">--</span>release<span style="color:#bbb"> </span><span style="color:#000;font-weight:bold">--</span>target<span style="color:#bbb"> </span>wasm32<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#bbb">
</span><span style="color:#bbb"></span>wasm<span style="color:#000;font-weight:bold">-</span>gc<span style="color:#bbb"> </span>target<span style="color:#000;font-weight:bold">/</span>wasm32<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#000;font-weight:bold">-</span>unknown<span style="color:#000;font-weight:bold">/</span>release<span style="color:#000;font-weight:bold">/</span>wasm.wasm<span style="color:#bbb"> </span>web<span style="color:#000;font-weight:bold">/</span>src<span style="color:#000;font-weight:bold">/</span>monkey.wasm<span style="color:#bbb">
</span></code></pre></td></tr></table>
</div>
</div><h1 id="参考">参考</h1>
<p><a href="https://ruslanspivak.com">Let’s Build A Simple Interpreter.</a>
<a href=""></a></p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2021-06-03.build-tiny-OS/">一种迷你操作系统</a></li>
        
        <li><a href="/post/2021-05-29.yuan-long-ping/">Yuan long ping</a></li>
        
        <li><a href="/post/2021-01-30-the-trait-in-Rust/">Trait in Rust</a></li>
        
        <li><a href="/post/2020-12-29-year-of-2020/">Year of 2020</a></li>
        
        <li><a href="/post/2020-12-15-Attention-is-all-your-need/">Attention is All your need</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/INTERPRETER'>INTERPRETER</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/HadXu/"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2022 <a href="https://hadxu.github.io">lay&#39;s 博客 By lay</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://hadxu.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://hadxu.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://hadxu.github.io/post/2022-02-08.happy-new-year/" title="2022新年第二篇">2022新年第二篇</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2022-01-01.new-year/" title="2022新年第一篇">2022新年第一篇</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-12-01.recent/" title="12月近况">12月近况</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-11-21-solution-of-CASPP-chapter2/" title="CASPP 第二章课后习题解答">CASPP 第二章课后习题解答</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-11-06.recent/" title="近况">近况</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-09-12.911/" title="911恐怖袭击">911恐怖袭击</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-07-22.henan/" title="No safe place">No safe place</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-06-21.A-tiny-Interpreter-written-by-Rust/" title="一种迷你解释器">一种迷你解释器</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-06-03.build-tiny-OS/" title="一种迷你操作系统">一种迷你操作系统</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-05-29.yuan-long-ping/" title="Yuan long ping">Yuan long ping</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://hadxu.github.io/categories/911/">911 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/CSAPP/">CSAPP (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/INTERPRETER/">INTERPRETER (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/OS/">OS (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/US/">US (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/algorithm/">algorithm (3)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/bash/">bash (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/deep-learning/">deep-learning (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/linux/">linux (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/pytorch/">pytorch (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/rust/">rust (13)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/ss/">ss (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/the-economist/">the economist (11)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/thunder/">thunder (4)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/tour/">tour (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E4%B8%AD%E5%9B%BD/">中国 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E5%A4%A7%E5%AD%A6/">大学 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%8A%95%E8%B5%84/">投资 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%97%A0%E4%BA%BA%E6%9C%BA/">无人机 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%97%A5%E5%B8%B8/">日常 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E7%94%9F%E6%B4%BB/">生活 (7)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%BA%BA/">经济学人 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://hadxu.github.io/tags/911/">911</a>
    
    <a href="https://hadxu.github.io/tags/CSAPP/">CSAPP</a>
    
    <a href="https://hadxu.github.io/tags/INTERPRETER/">INTERPRETER</a>
    
    <a href="https://hadxu.github.io/tags/OS/">OS</a>
    
    <a href="https://hadxu.github.io/tags/US/">US</a>
    
    <a href="https://hadxu.github.io/tags/algorithm/">algorithm</a>
    
    <a href="https://hadxu.github.io/tags/bash/">bash</a>
    
    <a href="https://hadxu.github.io/tags/deep-learning/">deep-learning</a>
    
    <a href="https://hadxu.github.io/tags/linux/">linux</a>
    
    <a href="https://hadxu.github.io/tags/pytorch/">pytorch</a>
    
    <a href="https://hadxu.github.io/tags/rust/">rust</a>
    
    <a href="https://hadxu.github.io/tags/ss/">ss</a>
    
    <a href="https://hadxu.github.io/tags/the-economist/">the economist</a>
    
    <a href="https://hadxu.github.io/tags/thunder/">thunder</a>
    
    <a href="https://hadxu.github.io/tags/tour/">tour</a>
    
    <a href="https://hadxu.github.io/tags/%E4%B8%AD%E5%9B%BD/">中国</a>
    
    <a href="https://hadxu.github.io/tags/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/">博客迁移</a>
    
    <a href="https://hadxu.github.io/tags/%E5%A4%A7%E5%AD%A6/">大学</a>
    
    <a href="https://hadxu.github.io/tags/%E5%A4%A7%E7%96%86/">大疆</a>
    
    <a href="https://hadxu.github.io/tags/%E6%8A%95%E8%B5%84/">投资</a>
    
    <a href="https://hadxu.github.io/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
    <a href="https://hadxu.github.io/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%BA%BA/">经济学人</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://hadxu.github.io" title="lay&#39;s 博客">lay&#39;s 博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://getmyte.com" title="The Economist">The Economist</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.linkedin.com/in/%e6%8c%af%e9%9b%b7-%e8%ae%b8-22aa5b133/" title="lay&#39;s Linkin">Linkin</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.kaggle.com/hadxu123" title="lay&#39;s Kaggle">kaggle</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://hadxu.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>