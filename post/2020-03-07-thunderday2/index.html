<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="referrer" content="no-referrer-when-downgrade">
    

    <title>从零实现深度学习框架(day2) | lay&#39;s 博客</title>
    <meta property="og:title" content="从零实现深度学习框架(day2) - lay&#39;s 博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2020-03-07T21:00:00&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2020-03-07T21:00:00&#43;08:00'>
        
    <meta name="Keywords" content="Python,Rust,Golang,6.824,">
    <meta name="description" content="从零实现深度学习框架(day2)">
        
    <meta name="author" content="lay">
    <meta property="og:url" content="https://hadxu.github.io/post/2020-03-07-thunderday2/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    <script data-ad-client="ca-pub-4031353640611810" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    
    
    
    
    
    
        <link rel="stylesheet" href='/css/douban.css'>
    
        <link rel="stylesheet" href='/css/other.css'>
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://hadxu.github.io">
                        lay&#39;s 博客
                    </a>
                
                <p class="description">专注于C,Python,Rust,Golang,Haskell,分布式系统,分布式计算,kindle,kaggle</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://hadxu.github.io">首页</a>
                    
                    <a  href="https://hadxu.github.io/books/" title="书籍">书籍</a>
                    
                    <a  href="https://hadxu.github.io/films/" title="电影">电影</a>
                    
                    <a  href="https://hadxu.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://hadxu.github.io/about/" title="关于">关于</a>
                    
                    <a  href="https://hadxu.github.io/pdfs/" title="pdfs">pdfs</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    <style type="text/css">
    .post-toc {
        position: fixed;
        width: 200px;
        margin-left: -210px;
        padding: 5px 10px;
        font-family: Athelas, STHeiti, Microsoft Yahei, serif;
        font-size: 12px;
        border: 1px solid rgba(0, 0, 0, .07);
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.98);
        background-clip: padding-box;
        -webkit-box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        box-shadow: 1px 1px 2px rgba(0, 0, 0, .125);
        word-wrap: break-word;
        white-space: nowrap;
        -webkit-box-sizing: border-box;
        box-sizing: border-box;
        z-index: 999;
        cursor: pointer;
        max-height: 70%;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .post-toc .post-toc-title {
        width: 100%;
        margin: 0 auto;
        font-size: 20px;
        font-weight: 400;
        text-transform: uppercase;
        text-align: center;
    }

    .post-toc .post-toc-content {
        font-size: 15px;
    }

    .post-toc .post-toc-content>nav>ul {
        margin: 10px 0;
    }

    .post-toc .post-toc-content ul {
        padding-left: 20px;
        list-style: square;
        margin: 0.5em;
        line-height: 1.8em;
    }

    .post-toc .post-toc-content ul ul {
        padding-left: 15px;
        display: none;
    }

    @media print,
    screen and (max-width:1057px) {
        .post-toc {
            display: none;
        }
    }
</style>
<div class="post-toc" style="position: absolute; top: 188px;">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
        <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li></li>
        <li><a href="#gpu操作的实现">GPU操作的实现</a></li>
      </ul>
    </li>
    <li><a href="#gpu操作的实现-1">GPU操作的实现</a></li>
  </ul>
</nav>
    </div>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        var postToc = $(".post-toc");
        if (postToc.length) {
            var leftPos = $("#main").offset().left;
            if(leftPos<220){
                postToc.css({"width":leftPos-10,"margin-left":(0-leftPos)})
            }

            var t = postToc.offset().top - 20,
                a = {
                    start: {
                        position: "absolute",
                        top: t
                    },
                    process: {
                        position: "fixed",
                        top: 20
                    },
                };
            $(window).scroll(function () {
                var e = $(window).scrollTop();
                e < t ? postToc.css(a.start) : postToc.css(a.process)
            })
        }
    })
</script>
    <article class="post">
        <header>
            <h1 class="post-title">从零实现深度学习框架(day2)</h1>
        </header>
        <date class="post-meta meta-date">
            2020年3月7日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/thunder'>thunder</a></span>
            
        </div>
        
        
        <div class="post-meta">
            <span id="busuanzi_container_page_pv">|<span id="busuanzi_value_page_pv"></span><span>
                    阅读</span></span>
        </div>
        
        
        <div class="clear" style="display: none">
            <div class="toc-article">
                <div class="toc-title">文章目录</div>
            </div>
        </div>
        
        <div class="post-content">
            <h4 id="前一天我们实现了cpu数据结构的操作今天我们实现gpu的操作">前一天我们实现了CPU数据结构的操作，今天我们实现GPU的操作。</h4>
<blockquote>
<p>CUDA是NVIDIA提出的并行计算框架，结合了CPU与GPU的优点，主要用来处理密集型并行计算。GPU用来提高计算密集型应用程序中并行程序段的执行速度。CUDA是非常重要的计算加速平台。</p>
</blockquote>
<p>需要注意的是，网上并没有特别好的GPU学习资源，只能够啃官方文档。</p>
<p>新建<code>cuda_device_api.h</code>文件，定义GPU端操作的各个函数。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#999;font-weight:bold;font-style:italic">#ifndef DLSYS_RUNTIME_CUDA_DEVICE_API_H_
</span><span style="color:#999;font-weight:bold;font-style:italic">#define DLSYS_RUNTIME_CUDA_DEVICE_API_H_
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;c_runtime_api.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;device_api.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;cuda_runtime.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;assert.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;string&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#000;font-weight:bold">class</span> <span style="color:#458;font-weight:bold">CUDADeviceAPI</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">public</span> DeviceAPI {
<span style="color:#000;font-weight:bold">public</span><span style="color:#000;font-weight:bold">:</span>
  <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>AllocDataSpace(DLContext ctx, size_t size, size_t alignment) <span style="color:#000;font-weight:bold">final</span>;

  <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">FreeDataSpace</span>(DLContext ctx, <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr) <span style="color:#000;font-weight:bold">final</span>;

  <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">CopyDataFromTo</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>from, <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>to, size_t size,
                      DLContext ctx_from, DLContext ctx_to,
                      DLStreamHandle stream) <span style="color:#000;font-weight:bold">final</span>;

  <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">StreamSync</span>(DLContext ctx, DLStreamHandle stream) <span style="color:#000;font-weight:bold">final</span>;
};
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>这段代码与CPU操作没有区别。</p>
</blockquote>
<p>实现GPU操作的方法</p>
<p>新建<code>cuda_device_api.cpp</code></p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&#34;./cuda_device_api.h&#34;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;cassert&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;cuda_runtime.h&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic">#include</span> <span style="color:#999;font-weight:bold;font-style:italic">&lt;iostream&gt;</span><span style="color:#999;font-weight:bold;font-style:italic">
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#998;font-style:italic">// 定义CUDA报错宏
</span><span style="color:#998;font-style:italic"></span><span style="color:#999;font-weight:bold;font-style:italic">#define CUDA_CALL(func)                                                        \
</span><span style="color:#999;font-weight:bold;font-style:italic">  {                                                                            \
</span><span style="color:#999;font-weight:bold;font-style:italic">    cudaError_t e = (func);                                                    \
</span><span style="color:#999;font-weight:bold;font-style:italic">    assert((e == cudaSuccess) || (e == cudaErrorCudartUnloading));             \
</span><span style="color:#999;font-weight:bold;font-style:italic">  }
</span><span style="color:#999;font-weight:bold;font-style:italic"></span>
<span style="color:#000;font-weight:bold">static</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">GPUCopy</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>from, <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>to, size_t size,
                    cudaMemcpyKind kind, cudaStream_t stream) {
  <span style="color:#000;font-weight:bold">if</span> (stream <span style="color:#000;font-weight:bold">!=</span> <span style="color:#099">0</span>) {
    CUDA_CALL(cudaMemcpyAsync(to, from, size, kind, stream));
  } <span style="color:#000;font-weight:bold">else</span> {
    CUDA_CALL(cudaMemcpy(to, from, size, kind));
  }
}

<span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>CUDADeviceAPI<span style="color:#000;font-weight:bold">::</span>AllocDataSpace(DLContext ctx, size_t size,
                                    size_t alignment) {
  <span style="color:#998;font-style:italic">// std::cout &lt;&lt; &#34;allocating cuda data&#34; &lt;&lt; std::endl;
</span><span style="color:#998;font-style:italic"></span>  CUDA_CALL(cudaSetDevice(ctx.device_id));
  assert((<span style="color:#099">256</span> <span style="color:#000;font-weight:bold">%</span> alignment) <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0U</span>); <span style="color:#998;font-style:italic">// &lt;&lt; &#34;CUDA space is aligned at 256 bytes&#34;;
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ret;
  CUDA_CALL(cudaMalloc(<span style="color:#000;font-weight:bold">&amp;</span>ret, size));
  <span style="color:#000;font-weight:bold">return</span> ret;
}

<span style="color:#458;font-weight:bold">void</span> CUDADeviceAPI<span style="color:#000;font-weight:bold">::</span>FreeDataSpace(DLContext ctx, <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>ptr) {
  CUDA_CALL(cudaSetDevice(ctx.device_id));
  CUDA_CALL(cudaFree(ptr));
}

<span style="color:#458;font-weight:bold">void</span> CUDADeviceAPI<span style="color:#000;font-weight:bold">::</span>CopyDataFromTo(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>from, <span style="color:#458;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">*</span>to, size_t size,
                                   DLContext ctx_from, DLContext ctx_to,
                                   DLStreamHandle stream) {
  <span style="color:#998;font-style:italic">// std::cout &lt;&lt; &#34;copying cuda data&#34; &lt;&lt; std::endl;
</span><span style="color:#998;font-style:italic"></span>  cudaStream_t cu_stream <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">static_cast</span><span style="color:#000;font-weight:bold">&lt;</span>cudaStream_t<span style="color:#000;font-weight:bold">&gt;</span>(stream);
  <span style="color:#000;font-weight:bold">if</span> (ctx_from.device_type <span style="color:#000;font-weight:bold">==</span> kGPU <span style="color:#000;font-weight:bold">&amp;&amp;</span> ctx_to.device_type <span style="color:#000;font-weight:bold">==</span> kGPU) {
    CUDA_CALL(cudaSetDevice(ctx_from.device_id));
    <span style="color:#000;font-weight:bold">if</span> (ctx_from.device_id <span style="color:#000;font-weight:bold">==</span> ctx_to.device_id) {
      GPUCopy(from, to, size, cudaMemcpyDeviceToDevice, cu_stream);
    } <span style="color:#000;font-weight:bold">else</span> {
      cudaMemcpyPeerAsync(to, ctx_to.device_id, from, ctx_from.device_id, size,
                          cu_stream);
    }
  } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (ctx_from.device_type <span style="color:#000;font-weight:bold">==</span> kGPU <span style="color:#000;font-weight:bold">&amp;&amp;</span> ctx_to.device_type <span style="color:#000;font-weight:bold">==</span> kCPU) {
    CUDA_CALL(cudaSetDevice(ctx_from.device_id));
    GPUCopy(from, to, size, cudaMemcpyDeviceToHost, cu_stream);
  } <span style="color:#000;font-weight:bold">else</span> <span style="color:#900;font-weight:bold">if</span> (ctx_from.device_type <span style="color:#000;font-weight:bold">==</span> kCPU <span style="color:#000;font-weight:bold">&amp;&amp;</span> ctx_to.device_type <span style="color:#000;font-weight:bold">==</span> kGPU) {
    CUDA_CALL(cudaSetDevice(ctx_to.device_id));
    GPUCopy(from, to, size, cudaMemcpyHostToDevice, cu_stream);
  } <span style="color:#000;font-weight:bold">else</span> {
    std<span style="color:#000;font-weight:bold">::</span>cerr <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#d14">&#34;expect copy from/to GPU or between GPU&#34;</span> <span style="color:#000;font-weight:bold">&lt;&lt;</span> std<span style="color:#000;font-weight:bold">::</span>endl;
  }
}

<span style="color:#458;font-weight:bold">void</span> CUDADeviceAPI<span style="color:#000;font-weight:bold">::</span>StreamSync(DLContext ctx, DLStreamHandle stream) {
  CUDA_CALL(cudaSetDevice(ctx.device_id));
  CUDA_CALL(cudaStreamSynchronize(<span style="color:#000;font-weight:bold">static_cast</span><span style="color:#000;font-weight:bold">&lt;</span>cudaStream_t<span style="color:#000;font-weight:bold">&gt;</span>(stream)));
}
</code></pre></td></tr></table>
</div>
</div><blockquote>
<p>分别实现了对应的操作。<code>AllocDataSpace</code>,<code>FreeDataSpace</code>,<code>CopyDataFromTo</code>,<code>StreamSync</code>。</p>
</blockquote>
<p>同时需要修改<code>c_runtime_api.cpp</code>里面的：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">7
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  DeviceAPIManager() {
    std<span style="color:#000;font-weight:bold">::</span>fill(api_.begin(), api_.end(), <span style="color:#000;font-weight:bold">nullptr</span>);
    <span style="color:#000;font-weight:bold">static</span> CPUDeviceAPI cpu_device_api_inst;
    <span style="color:#000;font-weight:bold">static</span> CUDADeviceAPI gpu_device_api_inst;
    api_[kCPU] <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">static_cast</span><span style="color:#000;font-weight:bold">&lt;</span>DeviceAPI <span style="color:#000;font-weight:bold">*&gt;</span>(<span style="color:#000;font-weight:bold">&amp;</span>cpu_device_api_inst);
    api_[kGPU] <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">static_cast</span><span style="color:#000;font-weight:bold">&lt;</span>DeviceAPI <span style="color:#000;font-weight:bold">*&gt;</span>(<span style="color:#000;font-weight:bold">&amp;</span>gpu_device_api_inst);
  }
</code></pre></td></tr></table>
</div>
</div><h3 id="gpu操作的实现">GPU操作的实现</h3>
<p>当完成了对GPU的操作，接下来实现GPU的各种方法，需要在框架中实现的，在框架中我们需要以下几种方法：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuArraySet</span>(DLArrayHandle arr, <span style="color:#458;font-weight:bold">float</span> value);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuBroadcastTo</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuReduceSumAxisZero</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixElementwiseAdd</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle matA,
                                <span style="color:#000;font-weight:bold">const</span> DLArrayHandle matB, DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixElementwiseAddByConst</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, <span style="color:#458;font-weight:bold">float</span> val,
                                       DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixElementwiseMultiply</span>(
      <span style="color:#000;font-weight:bold">const</span> DLArrayHandle matA, <span style="color:#000;font-weight:bold">const</span> DLArrayHandle matB, DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixMultiplyByConst</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, <span style="color:#458;font-weight:bold">float</span> val,
                                 DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixMultiply</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle matA, <span style="color:#458;font-weight:bold">bool</span> transposeA,
                          <span style="color:#000;font-weight:bold">const</span> DLArrayHandle matB, <span style="color:#458;font-weight:bold">bool</span> transposeB,
                          DLArrayHandle matC);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuRelu</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output);

  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuReluGradient</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, <span style="color:#000;font-weight:bold">const</span> DLArrayHandle in_grad,
                        DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuSoftmax</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output);
  <span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuSoftmaxCrossEntropy</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input_a,
                               <span style="color:#000;font-weight:bold">const</span> DLArrayHandle input_b,
                               DLArrayHandle output);
</code></pre></td></tr></table>
</div>
</div><p>分别对应着深度学习里面常用方法</p>
<ul>
<li>GPU设置数值</li>
<li>广播机制</li>
<li>对第一个维度进行累加</li>
<li>矩阵元素相乘</li>
<li>矩阵与常量相乘</li>
<li>矩阵相乘</li>
<li>矩阵相加</li>
<li>矩阵与常量相加</li>
<li>矩阵Relu激活</li>
<li>矩阵Relu导数</li>
<li>矩阵Softmax</li>
<li>Softmax交叉熵</li>
</ul>
<h2 id="gpu操作的实现-1">GPU操作的实现</h2>
<ol>
<li>GPU设置数值</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">array_set_kernel</span>(<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>array, <span style="color:#458;font-weight:bold">float</span> value, <span style="color:#458;font-weight:bold">int</span> n) {
    <span style="color:#458;font-weight:bold">int</span> index <span style="color:#000;font-weight:bold">=</span> blockIdx.x <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (index <span style="color:#000;font-weight:bold">&lt;</span> n) {
        array[index] <span style="color:#000;font-weight:bold">=</span> value;
    }
}


<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuArraySet</span>(DLArrayHandle arr, <span style="color:#458;font-weight:bold">float</span> value) { <span style="color:#998;font-style:italic">/* TODO: Your code here */</span>
    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> arr<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        n <span style="color:#000;font-weight:bold">=</span> n <span style="color:#000;font-weight:bold">*</span> arr<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>array_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) arr<span style="color:#000;font-weight:bold">-&gt;</span>data;

    <span style="color:#458;font-weight:bold">int</span> threads_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
    <span style="color:#458;font-weight:bold">int</span> num_blocks <span style="color:#000;font-weight:bold">=</span> (n <span style="color:#000;font-weight:bold">+</span> threads_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> threads_per_block;

    array_set_kernel <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> num_blocks, threads_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (array_data, value, n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="2">
<li>Broadcast</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">broadcast_to_kernel</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data,
                                    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data,
                                    index_t input_n,
                                    index_t output_n) {
    index_t idx <span style="color:#000;font-weight:bold">=</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (idx <span style="color:#000;font-weight:bold">&lt;</span> output_n) {
        output_data[idx] <span style="color:#000;font-weight:bold">=</span> input_data[idx <span style="color:#000;font-weight:bold">%</span> input_n];
    }
}


<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuBroadcastTo</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output) {
    index_t input_n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>)
        input_n <span style="color:#000;font-weight:bold">*=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];

    index_t output_n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> output<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>)
        output_n <span style="color:#000;font-weight:bold">*=</span> output<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];

    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;

    <span style="color:#458;font-weight:bold">int</span> thread_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">512</span>;
    <span style="color:#458;font-weight:bold">int</span> n_blocks <span style="color:#000;font-weight:bold">=</span> (output_n <span style="color:#000;font-weight:bold">+</span> thread_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> thread_per_block;
    broadcast_to_kernel <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> n_blocks, thread_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (input_data, output_data,
            input_n, output_n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="3">
<li>reduceSum</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">reduced_sum_axis_zero</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data, <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data, <span style="color:#458;font-weight:bold">int</span> input_n, <span style="color:#458;font-weight:bold">int</span> output_n) {
    <span style="color:#458;font-weight:bold">int</span> idx <span style="color:#000;font-weight:bold">=</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (idx <span style="color:#000;font-weight:bold">&lt;</span> output_n) {
        output_data[idx] <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0.0</span>;
        <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input_n <span style="color:#000;font-weight:bold">/</span> output_n; i<span style="color:#000;font-weight:bold">++</span>) {
            output_data[idx] <span style="color:#000;font-weight:bold">+=</span> input_data[i <span style="color:#000;font-weight:bold">*</span> output_n <span style="color:#000;font-weight:bold">+</span> idx];
        }
    }
}

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuReduceSumAxisZero</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output) {
    <span style="color:#458;font-weight:bold">int</span> input_n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        input_n <span style="color:#000;font-weight:bold">*=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#458;font-weight:bold">int</span> output_n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> output<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        output_n <span style="color:#000;font-weight:bold">*=</span> output<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;

    <span style="color:#458;font-weight:bold">int</span> thread_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
    <span style="color:#458;font-weight:bold">int</span> n_blocks <span style="color:#000;font-weight:bold">=</span> (output_n <span style="color:#000;font-weight:bold">+</span> thread_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> thread_per_block;

    reduced_sum_axis_zero <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> n_blocks, thread_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (input_data, output_data, input_n, output_n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="4">
<li>矩阵元素相加</li>
</ol>
<pre tabindex="0"><code>__global__ void matrix_elementwise_add(const float *a, const float *b, float *c,
                                       int n) {
    int index = blockIdx.x * blockDim.x + threadIdx.x;
    if (index &lt; n) {
        c[index] = a[index] + b[index];
    }
}

int DLGpuMatrixElementwiseAdd(const DLArrayHandle matA,
                              const DLArrayHandle matB, DLArrayHandle output) {
    int n = 1;
    for (int i = 0; i &lt; output-&gt;ndim; i++) {
        n = n * output-&gt;shape[i];
    }
    const float *data_A = (const float *) matA-&gt;data;
    const float *data_B = (const float *) matB-&gt;data;
    float *data_output = (float *) output-&gt;data;

    int threads_per_block = 1024;
    int num_blocks = (n + threads_per_block - 1) / threads_per_block;

    matrix_elementwise_add &lt;&lt; &lt; num_blocks, threads_per_block &gt;&gt; &gt; (data_A, data_B,
            data_output, n);
    return 0;
}
</code></pre><ol start="5">
<li>矩阵与常量相乘</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">marix_multiply_by_const</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>d_input, <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>d_output,
                                        <span style="color:#458;font-weight:bold">float</span> val, <span style="color:#458;font-weight:bold">int</span> n) {
    <span style="color:#458;font-weight:bold">int</span> index <span style="color:#000;font-weight:bold">=</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (index <span style="color:#000;font-weight:bold">&lt;</span> n) {
        d_output[index] <span style="color:#000;font-weight:bold">=</span> d_input[index] <span style="color:#000;font-weight:bold">*</span> val;
    }
}

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuMatrixMultiplyByConst</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, <span style="color:#458;font-weight:bold">float</span> val,
                               DLArrayHandle output) {
    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        n <span style="color:#000;font-weight:bold">*=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">int</span> threads_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
    <span style="color:#458;font-weight:bold">int</span> num_blocks <span style="color:#000;font-weight:bold">=</span> (n <span style="color:#000;font-weight:bold">+</span> threads_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> threads_per_block;
    marix_multiply_by_const <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> num_blocks, threads_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (input_data,
            output_data, val, n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="6">
<li>
<p>矩阵元素相加 同理</p>
</li>
<li>
<p>矩阵与常量相乘 同理</p>
</li>
<li>
<p>矩阵Relu激活</p>
</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">relu_kernel</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input, <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output, <span style="color:#458;font-weight:bold">int</span> n) {
    <span style="color:#458;font-weight:bold">int</span> index <span style="color:#000;font-weight:bold">=</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (index <span style="color:#000;font-weight:bold">&lt;</span> n) {
        <span style="color:#458;font-weight:bold">float</span> element <span style="color:#000;font-weight:bold">=</span> input[index];
        <span style="color:#000;font-weight:bold">if</span> (element <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#099">0</span>) {
            output[index] <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        } <span style="color:#000;font-weight:bold">else</span> {
            output[index] <span style="color:#000;font-weight:bold">=</span> element;
        }
    }
}

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuRelu</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output) {
    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        n <span style="color:#000;font-weight:bold">*=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">int</span> threads_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
    <span style="color:#458;font-weight:bold">int</span> num_blocks <span style="color:#000;font-weight:bold">=</span> (n <span style="color:#000;font-weight:bold">+</span> threads_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> threads_per_block;
    relu_kernel <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> num_blocks, threads_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (input_data, output_data, n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="9">
<li>矩阵Relu导数</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">relu_gradient_kernel</span>(<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input, <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output,
                                     <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>in_grad, <span style="color:#458;font-weight:bold">int</span> n) {
    <span style="color:#458;font-weight:bold">int</span> index <span style="color:#000;font-weight:bold">=</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockIdx.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (index <span style="color:#000;font-weight:bold">&lt;</span> n) {
        <span style="color:#458;font-weight:bold">float</span> element <span style="color:#000;font-weight:bold">=</span> input[index];
        <span style="color:#000;font-weight:bold">if</span> (element <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#099">0</span>) {
            output[index] <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
        } <span style="color:#000;font-weight:bold">else</span> {
            output[index] <span style="color:#000;font-weight:bold">=</span> in_grad[index];
        }
    }
}

<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuReluGradient</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, <span style="color:#000;font-weight:bold">const</span> DLArrayHandle in_grad,
                      DLArrayHandle output) {
    <span style="color:#458;font-weight:bold">int</span> n <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> input<span style="color:#000;font-weight:bold">-&gt;</span>ndim; i<span style="color:#000;font-weight:bold">++</span>) {
        n <span style="color:#000;font-weight:bold">*=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[i];
    }

    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>in_grad_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) in_grad<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">int</span> threads_per_block <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
    <span style="color:#458;font-weight:bold">int</span> num_blocks <span style="color:#000;font-weight:bold">=</span> (n <span style="color:#000;font-weight:bold">+</span> threads_per_block <span style="color:#000;font-weight:bold">-</span> <span style="color:#099">1</span>) <span style="color:#000;font-weight:bold">/</span> threads_per_block;

    relu_gradient_kernel <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> num_blocks, threads_per_block <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (input_data,
            output_data, in_grad_data, n);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="10">
<li>矩阵Softmax</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">softmax_kernel</span>(<span style="color:#458;font-weight:bold">int64_t</span> nrow, <span style="color:#458;font-weight:bold">int64_t</span> ncol,
                               <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data,
                               <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data) {

    <span style="color:#458;font-weight:bold">int</span> y <span style="color:#000;font-weight:bold">=</span> blockIdx.x <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockDim.y <span style="color:#000;font-weight:bold">+</span> threadIdx.y <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">+</span> threadIdx.x;
    <span style="color:#000;font-weight:bold">if</span> (y <span style="color:#000;font-weight:bold">&gt;=</span> nrow) {
        <span style="color:#000;font-weight:bold">return</span>;
    }
    input_data <span style="color:#000;font-weight:bold">+=</span> y <span style="color:#000;font-weight:bold">*</span> ncol;
    output_data <span style="color:#000;font-weight:bold">+=</span> y <span style="color:#000;font-weight:bold">*</span> ncol;
    <span style="color:#998;font-style:italic">// 找一行的最大值
</span><span style="color:#998;font-style:italic"></span>    <span style="color:#458;font-weight:bold">float</span> maxval <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>input_data;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
        maxval <span style="color:#000;font-weight:bold">=</span> max(maxval, input_data[x]);
    }
    <span style="color:#458;font-weight:bold">float</span> sum <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
        sum <span style="color:#000;font-weight:bold">+=</span> exp(input_data[x] <span style="color:#000;font-weight:bold">-</span> maxval);
    }
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
        output_data[x] <span style="color:#000;font-weight:bold">=</span> exp(input_data[x] <span style="color:#000;font-weight:bold">-</span> maxval) <span style="color:#000;font-weight:bold">/</span> sum;
    }
}


<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuSoftmax</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input, DLArrayHandle output) {
    assert(input<span style="color:#000;font-weight:bold">-&gt;</span>ndim <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">2</span>);
    assert(output<span style="color:#000;font-weight:bold">-&gt;</span>ndim <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">2</span>);
    <span style="color:#458;font-weight:bold">int64_t</span> nrow <span style="color:#000;font-weight:bold">=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">0</span>];
    <span style="color:#458;font-weight:bold">int64_t</span> ncol <span style="color:#000;font-weight:bold">=</span> input<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">1</span>];
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input<span style="color:#000;font-weight:bold">-&gt;</span>data;
    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;
    dim3 threads;
    <span style="color:#000;font-weight:bold">if</span> (nrow <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">1024</span>) {
        threads.x <span style="color:#000;font-weight:bold">=</span> nrow;
    } <span style="color:#000;font-weight:bold">else</span> {
        threads.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
        threads.y <span style="color:#000;font-weight:bold">=</span> (nrow <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1023</span>) <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">1024</span>;
    }
    softmax_kernel <span style="color:#000;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#099">1</span>, threads <span style="color:#000;font-weight:bold">&gt;&gt;</span> <span style="color:#000;font-weight:bold">&gt;</span> (nrow, ncol, input_data, output_data);
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><ol start="11">
<li>Softmax交叉熵</li>
</ol>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp">
<span style="color:#998;font-style:italic">// 求交叉熵
</span><span style="color:#998;font-style:italic">// np.mean(-np.sum(y_ * np.log(softmax(y)), axis=1), keepdims=True)
</span><span style="color:#998;font-style:italic"></span>__global__ <span style="color:#458;font-weight:bold">void</span> <span style="color:#900;font-weight:bold">matrix_softmax_cross_entropy_kernel</span>(<span style="color:#458;font-weight:bold">int</span> nrow, <span style="color:#458;font-weight:bold">int</span> ncol,
                                                    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_a,
                                                    <span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_b,
                                                    <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output) {
  <span style="color:#998;font-style:italic">// Dynamic shared memory, size provided at kernel launch.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">extern</span> __shared__ <span style="color:#458;font-weight:bold">float</span> loss_per_row[];
  <span style="color:#998;font-style:italic">// Two dimensional thread blocks.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">int</span> y <span style="color:#000;font-weight:bold">=</span> blockIdx.x <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">*</span> blockDim.y <span style="color:#000;font-weight:bold">+</span> threadIdx.y <span style="color:#000;font-weight:bold">*</span> blockDim.x <span style="color:#000;font-weight:bold">+</span>
          threadIdx.x;
  <span style="color:#000;font-weight:bold">if</span> (y <span style="color:#000;font-weight:bold">&gt;=</span> nrow) {
    <span style="color:#000;font-weight:bold">return</span>;
  }
  input_a <span style="color:#000;font-weight:bold">+=</span> y <span style="color:#000;font-weight:bold">*</span> ncol;
  input_b <span style="color:#000;font-weight:bold">+=</span> y <span style="color:#000;font-weight:bold">*</span> ncol;
  <span style="color:#458;font-weight:bold">float</span> maxval <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">*</span>input_a;
  <span style="color:#998;font-style:italic">// Find max for a row.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
    maxval <span style="color:#000;font-weight:bold">=</span> max(maxval, input_a[x]);
  }
  <span style="color:#998;font-style:italic">// Deduct by max for a row, and raise to exp.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">float</span> sum <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
  <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
    sum <span style="color:#000;font-weight:bold">+=</span> exp(input_a[x] <span style="color:#000;font-weight:bold">-</span> maxval);
  }
  <span style="color:#998;font-style:italic">// Compute per-row loss.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">float</span> loss <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
  <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; x <span style="color:#000;font-weight:bold">&lt;</span> ncol; <span style="color:#000;font-weight:bold">++</span>x) {
    loss <span style="color:#000;font-weight:bold">-=</span> input_b[x] <span style="color:#000;font-weight:bold">*</span> log(exp(input_a[x] <span style="color:#000;font-weight:bold">-</span> maxval) <span style="color:#000;font-weight:bold">/</span> sum);
  }
  loss_per_row[y] <span style="color:#000;font-weight:bold">=</span> loss;
  __syncthreads();
  <span style="color:#998;font-style:italic">// Compute reduce_mean across rows.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#458;font-weight:bold">float</span> mean_loss <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>;
  <span style="color:#998;font-style:italic">// Use a single thread to reduce mean across rows.
</span><span style="color:#998;font-style:italic"></span>  <span style="color:#000;font-weight:bold">if</span> ((threadIdx.x <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>) <span style="color:#000;font-weight:bold">&amp;&amp;</span> (threadIdx.y <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">0</span>)) {
    <span style="color:#000;font-weight:bold">for</span> (<span style="color:#458;font-weight:bold">int</span> i <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">0</span>; i <span style="color:#000;font-weight:bold">&lt;</span> nrow; <span style="color:#000;font-weight:bold">++</span>i) {
      mean_loss <span style="color:#000;font-weight:bold">+=</span> loss_per_row[i];
    }
    mean_loss <span style="color:#000;font-weight:bold">/=</span> nrow;
    output[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">=</span> mean_loss;
  }
}
<span style="color:#458;font-weight:bold">int</span> <span style="color:#900;font-weight:bold">DLGpuSoftmaxCrossEntropy</span>(<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input_a,
		<span style="color:#000;font-weight:bold">const</span> DLArrayHandle input_b, DLArrayHandle output) {
	assert(input_a<span style="color:#000;font-weight:bold">-&gt;</span>ndim <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">2</span>);
	assert(input_b<span style="color:#000;font-weight:bold">-&gt;</span>ndim <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">2</span>);
	assert(output<span style="color:#000;font-weight:bold">-&gt;</span>ndim <span style="color:#000;font-weight:bold">==</span> <span style="color:#099">1</span>);
	assert(
			input_a<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">0</span>] <span style="color:#000;font-weight:bold">==</span> input_b<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">0</span>]
					<span style="color:#000;font-weight:bold">&amp;&amp;</span> input_a<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">1</span>] <span style="color:#000;font-weight:bold">==</span> input_b<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">1</span>]);
	<span style="color:#458;font-weight:bold">int</span> nrow <span style="color:#000;font-weight:bold">=</span> input_a<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">0</span>];
	assert(nrow <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#099">1024</span> <span style="color:#000;font-weight:bold">*</span> <span style="color:#099">4</span>);
	<span style="color:#458;font-weight:bold">int</span> ncol <span style="color:#000;font-weight:bold">=</span> input_a<span style="color:#000;font-weight:bold">-&gt;</span>shape[<span style="color:#099">1</span>];
	<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data_a <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input_a<span style="color:#000;font-weight:bold">-&gt;</span>data;
	<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>input_data_b <span style="color:#000;font-weight:bold">=</span> (<span style="color:#000;font-weight:bold">const</span> <span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) input_b<span style="color:#000;font-weight:bold">-&gt;</span>data;
	<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>output_data <span style="color:#000;font-weight:bold">=</span> (<span style="color:#458;font-weight:bold">float</span> <span style="color:#000;font-weight:bold">*</span>) output<span style="color:#000;font-weight:bold">-&gt;</span>data;
	dim3 threads;
	<span style="color:#000;font-weight:bold">if</span> (nrow <span style="color:#000;font-weight:bold">&lt;=</span> <span style="color:#099">1024</span>) {
		threads.x <span style="color:#000;font-weight:bold">=</span> nrow;
	} <span style="color:#000;font-weight:bold">else</span> {
		threads.x <span style="color:#000;font-weight:bold">=</span> <span style="color:#099">1024</span>;
		threads.y <span style="color:#000;font-weight:bold">=</span> (nrow <span style="color:#000;font-weight:bold">+</span> <span style="color:#099">1023</span>) <span style="color:#000;font-weight:bold">/</span> <span style="color:#099">1024</span>;
	}
	matrix_softmax_cross_entropy_kernel<span style="color:#000;font-weight:bold">&lt;&lt;&lt;</span><span style="color:#099">1</span>, threads, nrow <span style="color:#000;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">sizeof</span>(<span style="color:#458;font-weight:bold">float</span>)<span style="color:#000;font-weight:bold">&gt;&gt;&gt;</span>(
			nrow, ncol, input_data_a, input_data_b, output_data);
	<span style="color:#000;font-weight:bold">return</span> <span style="color:#099">0</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>到这里所有的数据结构的操作全部完成，接下来将其编译成动态链接库。</p>
<p>在与<code>src</code>平级的文件夹下，新建<code>Makefile</code>文件。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#008080">CUDA_DIR</span> <span style="color:#000;font-weight:bold">=</span> /usr/local/cuda

<span style="color:#008080">CC_SRCS</span> <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">$(</span>wildcard src/*.cc<span style="color:#000;font-weight:bold">)</span>
<span style="color:#008080">CC_OBJS</span> <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">${</span><span style="color:#008080">CC_SRCS</span>:<span style="color:#008080">src</span>/%.cc=build/obj/%.o<span style="color:#d14">}</span>
<span style="color:#008080">CUDA_SRCS</span> <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">$(</span>wildcard src/*.cu<span style="color:#000;font-weight:bold">)</span>
<span style="color:#008080">CUDA_OBJS</span> <span style="color:#000;font-weight:bold">:=</span> <span style="color:#d14">${</span><span style="color:#008080">CUDA_SRCS</span>:<span style="color:#008080">src</span>/%.cu=build/obj/%.o<span style="color:#d14">}</span>
<span style="color:#008080">OBJS</span> <span style="color:#000;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">$(</span>CC_OBJS<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">$(</span>CUDA_OBJS<span style="color:#000;font-weight:bold">)</span>

<span style="color:#008080">CC</span> <span style="color:#000;font-weight:bold">=</span> g++
<span style="color:#008080">WARNINGS</span> <span style="color:#000;font-weight:bold">=</span> -Wall -Wfatal-errors -Wno-unused -Wno-unused-result
<span style="color:#008080">CC_FLAGS</span> <span style="color:#000;font-weight:bold">=</span> -std<span style="color:#000;font-weight:bold">=</span>c++11 -fPIC <span style="color:#000;font-weight:bold">$(</span>WARNINGS<span style="color:#000;font-weight:bold">)</span> -I<span style="color:#000;font-weight:bold">$(</span>CUDA_DIR<span style="color:#000;font-weight:bold">)</span>/include
<span style="color:#008080">LD_FLAGS</span> <span style="color:#000;font-weight:bold">=</span> -L<span style="color:#000;font-weight:bold">$(</span>CUDA_DIR<span style="color:#000;font-weight:bold">)</span>/lib64 -lcuda -lcudart -lcublas

<span style="color:#008080">NVCC</span> <span style="color:#000;font-weight:bold">=</span> nvcc
<span style="color:#008080">NVCC_FLAGS</span> <span style="color:#000;font-weight:bold">=</span> -std<span style="color:#000;font-weight:bold">=</span>c++11 --compiler-options <span style="color:#d14">&#39;-fPIC&#39;</span>
<span style="color:#008080">ARCH</span> <span style="color:#000;font-weight:bold">=</span> -gencode <span style="color:#008080">arch</span><span style="color:#000;font-weight:bold">=</span>compute_30,code<span style="color:#000;font-weight:bold">=</span>sm_30 <span style="color:#d14">\
</span><span style="color:#d14"></span>       -gencode <span style="color:#008080">arch</span><span style="color:#000;font-weight:bold">=</span>compute_35,code<span style="color:#000;font-weight:bold">=</span>sm_35 <span style="color:#d14">\
</span><span style="color:#d14"></span>       -gencode <span style="color:#008080">arch</span><span style="color:#000;font-weight:bold">=</span>compute_50,code<span style="color:#000;font-weight:bold">=[</span>sm_50,compute_50<span style="color:#000;font-weight:bold">]</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>       -gencode <span style="color:#008080">arch</span><span style="color:#000;font-weight:bold">=</span>compute_52,code<span style="color:#000;font-weight:bold">=[</span>sm_52,compute_52<span style="color:#000;font-weight:bold">]</span>

<span style="color:#900;font-weight:bold">all</span><span style="color:#000;font-weight:bold">:</span> build/lib/libc_runtime_api.so

<span style="color:#900;font-weight:bold">build/lib/libc_runtime_api.so</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">$(</span><span style="color:#008080">OBJS</span><span style="color:#000;font-weight:bold">)</span>
	@mkdir -p build/lib
	<span style="color:#000;font-weight:bold">$(</span>CC<span style="color:#000;font-weight:bold">)</span> -shared $^ -o <span style="color:#008080">$@</span> <span style="color:#000;font-weight:bold">$(</span>LD_FLAGS<span style="color:#000;font-weight:bold">)</span>

<span style="color:#900;font-weight:bold">build/obj/%.o</span><span style="color:#000;font-weight:bold">:</span> src/%.cc
	@mkdir -p build/obj
	<span style="color:#000;font-weight:bold">$(</span>CC<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">$(</span>CC_FLAGS<span style="color:#000;font-weight:bold">)</span> -c $&lt; -o <span style="color:#008080">$@</span>

<span style="color:#900;font-weight:bold">build/obj/%.o</span><span style="color:#000;font-weight:bold">:</span> src/%.cu
	@mkdir -p build/obj
	<span style="color:#000;font-weight:bold">$(</span>NVCC<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">$(</span>ARCH<span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">$(</span>NVCC_FLAGS<span style="color:#000;font-weight:bold">)</span> -c $&lt; -o <span style="color:#008080">$@</span>

<span style="color:#900;font-weight:bold">clean</span><span style="color:#000;font-weight:bold">:</span>
	rm -rf build

<span style="color:#900;font-weight:bold">.PHONY</span><span style="color:#000;font-weight:bold">:</span> clean
</code></pre></td></tr></table>
</div>
</div><p>打开Linux命令行，执行<code>make</code>操作，就可以得到<code>libc_runtime_api.so</code>文件，接下来的所有的操作就围绕着该动态链接库来进行。</p>
<blockquote>
<p>在该GPU实现中，需要用了很多数学知识，关于softmax的推导蛮好的资料在<a href="https://peterroelants.github.io/posts/neural_network_implementation_intermezzo02/">
How to implement a neural network Intermezzo</a>.</p>
</blockquote>
<p>接下来实现Python调用该so文件进行无缝链接。</p>

        </div>

        


        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/post/2020-03-06-thunderday1/">从零实现深度学习框架(day1)</a></li>
        
        <li><a href="/post/2020-03-01-the-tour-of-thailand/">泰国游玩</a></li>
        
        <li><a href="/post/2020-03-01-the-best-way-to-fq/">FQ(科学上网)的正确打开方式</a></li>
        
        <li><a href="/post/2020-03-01-blog-change/">博客迁移</a></li>
        
        <li><a href="/pdfs/">pdfs</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/thunder'>thunder</a></li>
                
            </ul>
            
        </div>
    </article>
    
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "yourdiscussshortname" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "https://github.com/HadXu/"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://hadxu.github.io">lay&#39;s 博客 By lay</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by</span><span class="badge-value bg-blue">Hugo</span></a>
        </div>
        <div class="github-badge">
            <a href="https://www.flysnow.org/" target="_black"><span class="badge-subject">Design by</span><span class="badge-value bg-brightgreen">飞雪无情</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme</span><span class="badge-value bg-yellowgreen">Maupassant</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>



    <script type="text/javascript" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script>




    <script src='/js/douban.js'></script>

                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://hadxu.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://hadxu.github.io">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://hadxu.github.io/post/2021-12-01.recent/" title="12月近况">12月近况</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-11-21-solution-of-CASPP-chapter2/" title="CASPP 第二章课后习题解答">CASPP 第二章课后习题解答</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-11-06.recent/" title="近况">近况</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-09-12.911/" title="911恐怖袭击">911恐怖袭击</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-07-22.henan/" title="No safe place">No safe place</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-06-21.A-tiny-Interpreter-written-by-Rust/" title="一种迷你解释器">一种迷你解释器</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-06-03.build-tiny-OS/" title="一种迷你操作系统">一种迷你操作系统</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-05-29.yuan-long-ping/" title="Yuan long ping">Yuan long ping</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2021-01-30-the-trait-in-Rust/" title="Trait in Rust">Trait in Rust</a>
    </li>
    
    <li>
        <a href="https://hadxu.github.io/post/2020-12-29-year-of-2020/" title="Year of 2020">Year of 2020</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://hadxu.github.io/categories/911/">911 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/CSAPP/">CSAPP (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/INTERPRETER/">INTERPRETER (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/OS/">OS (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/US/">US (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/algorithm/">algorithm (3)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/bash/">bash (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/deep-learning/">deep-learning (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/linux/">linux (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/pytorch/">pytorch (2)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/rust/">rust (13)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/ss/">ss (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/the-economist/">the economist (11)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/thunder/">thunder (4)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/tour/">tour (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E4%B8%AD%E5%9B%BD/">中国 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E5%A4%A7%E5%AD%A6/">大学 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%8A%95%E8%B5%84/">投资 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%97%A0%E4%BA%BA%E6%9C%BA/">无人机 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E6%97%A5%E5%B8%B8/">日常 (1)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E7%94%9F%E6%B4%BB/">生活 (5)</a></li>
    
    <li><a href="https://hadxu.github.io/categories/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%BA%BA/">经济学人 (1)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://hadxu.github.io/tags/911/">911</a>
    
    <a href="https://hadxu.github.io/tags/CSAPP/">CSAPP</a>
    
    <a href="https://hadxu.github.io/tags/INTERPRETER/">INTERPRETER</a>
    
    <a href="https://hadxu.github.io/tags/OS/">OS</a>
    
    <a href="https://hadxu.github.io/tags/US/">US</a>
    
    <a href="https://hadxu.github.io/tags/algorithm/">algorithm</a>
    
    <a href="https://hadxu.github.io/tags/bash/">bash</a>
    
    <a href="https://hadxu.github.io/tags/deep-learning/">deep-learning</a>
    
    <a href="https://hadxu.github.io/tags/linux/">linux</a>
    
    <a href="https://hadxu.github.io/tags/pytorch/">pytorch</a>
    
    <a href="https://hadxu.github.io/tags/rust/">rust</a>
    
    <a href="https://hadxu.github.io/tags/ss/">ss</a>
    
    <a href="https://hadxu.github.io/tags/the-economist/">the economist</a>
    
    <a href="https://hadxu.github.io/tags/thunder/">thunder</a>
    
    <a href="https://hadxu.github.io/tags/tour/">tour</a>
    
    <a href="https://hadxu.github.io/tags/%E4%B8%AD%E5%9B%BD/">中国</a>
    
    <a href="https://hadxu.github.io/tags/%E5%8D%9A%E5%AE%A2%E8%BF%81%E7%A7%BB/">博客迁移</a>
    
    <a href="https://hadxu.github.io/tags/%E5%A4%A7%E5%AD%A6/">大学</a>
    
    <a href="https://hadxu.github.io/tags/%E5%A4%A7%E7%96%86/">大疆</a>
    
    <a href="https://hadxu.github.io/tags/%E6%8A%95%E8%B5%84/">投资</a>
    
    <a href="https://hadxu.github.io/tags/%E7%94%9F%E6%B4%BB/">生活</a>
    
    <a href="https://hadxu.github.io/tags/%E7%BB%8F%E6%B5%8E%E5%AD%A6%E4%BA%BA/">经济学人</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://hadxu.github.io" title="lay&#39;s 博客">lay&#39;s 博客</a>
        </li>
        
        <li>
            <a target="_blank" href="https://getmyte.com" title="The Economist">The Economist</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.linkedin.com/in/%e6%8c%af%e9%9b%b7-%e8%ae%b8-22aa5b133/" title="lay&#39;s Linkin">Linkin</a>
        </li>
        
        <li>
            <a target="_blank" href="https://www.kaggle.com/hadxu123" title="lay&#39;s Kaggle">kaggle</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://hadxu.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>